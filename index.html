<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LSAFERS Auth Demo</title>

    <!-- Supabase JS client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <h1>LSAFERS Auth Demo</h1>

    <div>
      <input id="email" placeholder="email" />
      <input id="password" type="password" placeholder="password" />
      <button onclick="login()">Login</button>
    </div>

    <hr />

    <button onclick="callBackend()">Call Protected Backend</button>

    <pre id="output">Not logged in</pre>

<hr />

<input type="file" id="file" />
<button onclick="upload()">Upload File</button>

<p><a id="download" target="_blank"></a></p>

    <script>
      // ðŸ”´ REPLACE THESE TWO VALUES
      const SUPABASE_URL = "https://alrvzkpvzbemizsjeozw.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_5lnKeDUnm1gH4eNFVpgNgg_yDe76fJG";

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      supabaseClient.auth.onAuthStateChange((event, session) => {
        if (session) {
          document.getElementById("output").textContent =
            "Logged in as " + session.user.email;
        }
      });

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          document.getElementById("output").textContent = error.message;
          return;
        }

        document.getElementById("output").textContent =
          "Logged in as " + data.user.email;
      }

      async function callBackend() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();

        if (!session) {
          document.getElementById("output").textContent =
            "Not logged in";
          return;
        }

        const res = await fetch(
          "https://lsafers-backend.onrender.com/protected",
          {
            headers: {
              Authorization: `Bearer ${session.access_token}`,
            },
          }
        );

        const json = await res.json();
        document.getElementById("output").textContent =
          JSON.stringify(json, null, 2);
      }

      async function upload() {
        const file = document.getElementById("file").files[0];
        if (!file) return alert("Choose a file");

        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
            
        const res = await fetch(
          "https://lsafers-backend.onrender.com/upload",
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${session.access_token}`,
            },
            body: await file.text(),
          }
        );

        const json = await res.json();

        const link = document.getElementById("download");
        link.href = `https://lsafers-backend.onrender.com${json.downloadUrl}`;
        link.textContent = "Download uploaded file";
      }
    </script>
  </body>
</html>